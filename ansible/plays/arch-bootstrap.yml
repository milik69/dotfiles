---
- name: bootstrap arch
  hosts: localhost
  vars_prompt:
    - name: "hostname"
      prompt: "enter hostname"
      private: no
    - name: "username"
      prompt: "admin username"
      private: no
    - name: "user_password"
      prompt: "admin password"
      confirm: yes
    - name: "ssh_pubkey"
      prompt: "ssh pubkey"
      private: no
    - name: "ip_address"
      prompt: "fixed ip address"
      private: no
      default: "127.0.1.1"
    - name: "sshd_port"
      prompt: "sshd port"
      private: no
      default: "22"
  vars:
    # https checkout of dotfiles before ssh forwarding is possible
    github_base: "https://github.com/"

  tasks:
    - name: basic install
      include_role:
        name: arch
        tasks_from: install
      when: ansible_architecture == "x86_64"

    - name: create admin user
      include_role:
        name: arch
        tasks_from: create-admin

    - name: enable remote access
      include_role:
        name: arch
        tasks_from: sshd

    - name: install dotfiles deps
      include_role:
        name: dotfiles
        tasks_from: deps

    - name: configure ssh agent forwarding for github
      set_fact:
        ssh_auth_sock: "{{ ansible_env.SSH_AUTH_SOCK if ansible_bios_version != 'VirtualBox' else '/var/run/authsocket.sock' }}"

    - name: hack ssh socket on vagrant
      shell: "socat UNIX-LISTEN:/var/run/authsocket.sock,umask=077,user={{ username }},fork \"UNIX:$SSH_AUTH_SOCK\""
      when: ansible_bios_version != 'VirtualBox'

    - name:

    - name: setup dotfiles
      import_role:
        name: dotfiles
      environment:
        SSH_AUTH_SOCK: "{{ ssh_auth_sock }}"
      become: yes
      become_user: "{{ username }}"

    - name: delete ssh socket hack
      file:
        path: /var/run/authsocket.sock
        state: absent
      when: ansible_bios_version != 'VirtualBox'

    - name: setup aur helper
      import_role:
        name: arch
        tasks_from: aur
      become: yes
      become_user: "{{ username }}"

    # TODO: amd/intel microcode


